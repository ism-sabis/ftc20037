name: Optimize Images

on:
  push:
    paths:
      - 'assets/images/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  optimize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install image optimization tools
        run: npm install -g sharp-cli imagemin-cli

      - name: Optimize images
        run: |
          # Find and optimize PNG images
          find assets/images -name "*.png" -type f -exec sh -c '
            for img; do
              echo "Optimizing: $img"
              sharp -i "$img" -o "$img" --quality 85 2>/dev/null || true
            done
          ' sh {} +

          # Find and optimize JPEG images
          find assets/images -name "*.jpg" -o -name "*.jpeg" -type f -exec sh -c '
            for img; do
              echo "Optimizing: $img"
              sharp -i "$img" -o "$img" --quality 85 2>/dev/null || true
            done
          ' sh {} +

      - name: Commit optimized images
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/images/
          git diff --staged --quiet || git commit -m "Optimize images"
          git push
